<html>

<head>

    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <script>

        var worker;
        var deviceId;
        var isRecognizing=false;
        async function init() {
            worker = await Tesseract.createWorker({
                logger: m => console.log(m)
            });

            await worker.loadLanguage('jpn');
            await worker.initialize('jpn');
            await worker.setParameters({
                tessedit_char_whitelist: 'あいうえおかきくけこさしすせそたちつてとなにぬねのやゆよらりるれろわをん!！アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘノマムミメモヤユヨラリルレロワヲン',

                //tessedit_char_whitelist: 'やられたヤラレタ！'
            });
            const devices = (await navigator.mediaDevices.enumerateDevices())
                .filter((device) => (device.kind === 'videoinput') && (device.label === "OBS Virtual Camera"));

            console.log(devices[0].deviceId);
            deviceId = devices[0].deviceId;

            const video = document.querySelector("#camera");
            const canvas = document.querySelector("#picture");
            const se = document.querySelector('#se');

            /** カメラ設定 */
            const constraints = {
                audio: false,
                video: {
                    width: 1280,
                    height: 720,
                    deviceId: deviceId,

                }
            };



            navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    video.srcObject = stream;
                    video.onloadedmetadata = (e) => {
                        video.play();
                    };
                })
                .catch((err) => {
                    console.log(err.name + ": " + err.message);
                });

            setInterval(function () {
                if(!isRecognizing)
                recognize();
            }, 5000);

            async function recognize() {
                console.log("recognize");
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 480, 600, 640, 480, 0, 0, 1280, 720);
                isRecognizing=true;
                const { data: { text } } = await worker.recognize(canvas);
                isRecognizing=false;
                var recongizedText = text.replace(/\s+/g, "");
                console.log(recongizedText);
                console.log(recongizedText.includes("たおした"));
            }

        }


        init();



    </script>
</head>

<body>
    <video id="camera" width="640" height="360"></video>
    <canvas id="picture" width="640" height="360"></canvas>
</body>

</html>